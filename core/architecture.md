# Architecture Principles

アーキテクチャ原則と設計パターンに関する共通ルールです。

## 概要

このルールは、モノレポ構造、共通基盤の活用、依存関係管理などのアーキテクチャ原則を定義します。プロジェクトの規模や技術スタックに関わらず適用される基本原則です。

## 基本原則

### 1. モノレポ構造の原則

**モノレポ構造を採用する場合の原則**:
- 共通基盤と機能モジュールを明確に分離
- 各モジュールの責務を明確に定義
- モジュール間の依存関係を最小化

**推奨ディレクトリ構造**:
```
project-root/
├── common/              # 共通基盤ライブラリ
│   ├── src/
│   │   ├── config/      # 設定管理
│   │   ├── services/    # サービス層
│   │   ├── types/       # 型定義
│   │   └── utils/       # ユーティリティ
├── module-1/            # 機能モジュール1
├── module-2/            # 機能モジュール2
└── docs/                # 要件定義書とAPI仕様書
```

### 2. 共通基盤の活用原則

**共通基盤で実装すべき機能**:
- **設定管理**: 環境変数、API設定、データベース設定等
- **インフラ設定**: ビルド設定、デプロイ設定、スケジューラー設定等
- **ユーティリティ**: ログ、エラーハンドリング、データ変換等
- **型定義**: 共通で使用される型、インターフェース等

**モジュール固有で実装すべき機能**:
- **ビジネスロジック**: 各モジュール固有の処理
- **API実装**: モジュール固有のエンドポイント
- **データ処理**: モジュール固有のデータ変換・処理

### 3. 共通化の判断基準

**共通化すべき機能の判断フロー**:
```
1. 機能の分析
   ↓
2. 他モジュールでの使用可能性の確認
   ↓
3. 共通化のメリット・デメリットの評価
   ↓
4. 共通基盤での実装 vs モジュール固有実装の判断
   ↓
5. 共通基盤での実装（推奨）
```

**共通化のメリット**:
- コードの重複削減
- 一貫性の確保
- 保守性の向上
- テストの効率化

**共通化のデメリット**:
- 過度な抽象化による複雑性の増加
- 不要な依存関係の発生
- 変更の影響範囲の拡大

### 4. 依存関係管理とビルド順序の原則

**🚨 重要な依存関係管理ルール**:

**1. ビルド順序の厳守**
- 共通基盤を必ず先にビルド
- 共通基盤のビルド完了後に各モジュールをビルド
- 依存関係の解決を確認してからビルド実行

**2. 依存関係の解決確認**
- ビルド前確認: 共通基盤の`dist`ディレクトリが存在することを確認
- 型定義の確認: 共通基盤の型定義が利用可能であることを確認
- パッケージ参照の確認: 各モジュールで共通基盤が正しく参照されることを確認

**3. 疎結合維持の実装パターン**
- 共通基盤で環境変数・設定を一元管理
- モジュールは共通基盤に依存
- 設定の一元管理を実現

**4. ビルドエラーの診断手順**
```bash
# Step 1: 共通基盤のビルド確認
cd common && npm run build

# Step 2: distディレクトリの存在確認
ls -la common/dist/

# Step 3: 各モジュールのビルド確認
cd module-1 && npm run build
cd module-2 && npm run build
```

**5. 禁止事項**
- ❌ **禁止**: 共通基盤をビルドせずに各モジュールをビルド
- ❌ **禁止**: ビルド順序を無視した実装
- ❌ **禁止**: 依存関係の解決確認なしでのビルド実行

**6. 推奨事項**
- ✅ **推奨**: 共通基盤のビルド完了確認後に各モジュールをビルド
- ✅ **推奨**: ビルド順序を明示的に実装（Dockerfile、CI/CD等）
- ✅ **推奨**: ビルドエラー時は依存関係の解決状況を確認

### 5. データベース開発アプローチ

**段階的アプローチの原則**:
```
ローカル開発 → ローカルデータベース → 開発環境 → 本番環境
```

**各環境の役割**:
- **ローカル開発**: 一次開発・テスト用
- **ローカルデータベース**: ローカル環境でのデータベース開発・テスト
- **開発環境**: 統合テスト・検証用
- **本番環境**: 本番運用用

**データベース管理ルール**:
- **マイグレーション管理**: 環境別に適切に管理
- **データ管理**: 環境別に適切に管理
- **スキーマ同期**: 環境間でのスキーマ整合性を維持

**データベース開発のベストプラクティス**:
1. **段階的開発**: ローカル環境での開発完了後に次の環境へ
2. **データの整合性**: 環境間でのデータの整合性を常に維持
3. **テストの実施**: 各環境での単体テスト・統合テスト実行
4. **ロールバック計画**: 各環境でのロールバック手順を準備

## 具体的な指針

### モノレポ構造の実装

**共通基盤の設計**:
- 設定管理は共通基盤で一元管理
- ログ、エラーハンドリングは共通基盤で提供
- 型定義は共通基盤で定義

**モジュールの設計**:
- モジュールは共通基盤に依存
- モジュール間の直接依存を避ける
- モジュール固有のビジネスロジックを実装

### 共通化の実装パターン

**設定系の共通化**:
- 環境変数の管理を共通基盤で実装
- 設定値の一元管理
- 環境別設定の自動切り替え

**ユーティリティの共通化**:
- ログ機能を共通基盤で提供
- エラーハンドリングを共通基盤で提供
- データ変換ユーティリティを共通基盤で提供

**型定義の共通化**:
- 共通で使用される型を共通基盤で定義
- インターフェースを共通基盤で定義
- 型の一貫性を確保

### 依存関係管理の実装

**Dockerfileでのビルド順序実装**:
```dockerfile
# 正しいビルド順序（必須）
# 共通基盤のビルド（先に実行）
RUN cd common && npm run build

# 各モジュールのビルド（共通基盤の後に実行）
RUN cd module-1 && npm run build
RUN cd module-2 && npm run build
```

**CI/CDでのビルド順序実装**:
```yaml
# ビルド順序を明示的に定義
steps:
  - name: Build common
    run: cd common && npm run build
  
  - name: Build modules
    run: |
      cd module-1 && npm run build
      cd module-2 && npm run build
```

## 例外・特別なケース

### プロジェクト固有の構造

モノレポ構造を採用しない場合:
- プロジェクトの規模や要件に応じて構造を調整
- 共通基盤の原則は維持
- 依存関係管理の原則は維持

### レガシーコードへの対応

既存のコードベースに導入する場合:
- 段階的な共通化を実施
- 既存コードへの影響を最小化
- 共通基盤への移行を計画的に実施

## 参考リンク

- [Monorepo Best Practices](https://monorepo.tools/)
- [Dependency Management Best Practices](https://docs.npmjs.com/cli/v9/configuring-npm/package-json#dependencies)
- [TypeScript Project References](https://www.typescriptlang.org/docs/handbook/project-references.html)

